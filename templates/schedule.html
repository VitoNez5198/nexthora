{% extends "base.html" %}

{% block title %}Mi Horario - Nexthora{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto py-8">
    
    <!-- ENCABEZADO -->
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold text-dark-gray">üìÖ Configuraci√≥n de Horario</h1>
        <a href="{% url 'dashboard' %}" class="text-gray-500 hover:text-primary text-sm">‚Üê Volver al Dashboard</a>
    </div>

    <!-- MENSAJES DE ERROR/EXITO -->
    {% if messages %}
        <div class="mb-6">
            {% for message in messages %}
                <div class="p-4 rounded-lg {% if message.tags == 'success' %}bg-green-100 text-green-700{% else %}bg-red-100 text-red-700{% endif %}">
                    {{ message }}
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        
        <!-- SECCI√ìN 1: HORARIO SEMANAL -->
        <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
            <h2 class="text-lg font-bold text-dark-gray mb-4 flex items-center gap-2">
                üîÑ Horario Semanal
                <span class="text-xs font-normal text-gray-500 bg-gray-100 px-2 py-1 rounded">Se repite siempre</span>
            </h2>
            
            <form method="POST" class="mb-6 bg-gray-50 p-4 rounded-md border border-gray-200">
                {% csrf_token %}
                <div class="space-y-3">
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase">D√≠a</label>
                        {{ hours_form.weekday }}
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="text-xs font-bold text-gray-500 uppercase">Desde</label>
                            {{ hours_form.start_time }}
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-500 uppercase">Hasta</label>
                            {{ hours_form.end_time }}
                        </div>
                    </div>
                    <button type="submit" name="submit_hours" class="w-full bg-primary text-white py-2 rounded hover:bg-blue-700 text-sm font-bold">
                        + A√±adir Horario
                    </button>
                </div>
            </form>

            <div class="space-y-2 max-h-60 overflow-y-auto">
                {% for hours in schedule %}
                <div class="flex justify-between items-center text-sm border-b border-gray-100 pb-2 last:border-0">
                    <div>
                        <span class="font-bold text-gray-700">{{ hours.get_weekday_display }}</span>
                        <span class="text-gray-500 ml-2">{{ hours.start_time|time:"H:i" }} - {{ hours.end_time|time:"H:i" }}</span>
                    </div>
                    <form method="POST" action="{% url 'delete_schedule' hours.id %}" onsubmit="return confirm('¬øBorrar este horario?');">
                        {% csrf_token %}
                        <button type="submit" class="text-red-400 hover:text-red-600 font-bold px-2">‚úï</button>
                    </form>
                </div>
                {% empty %}
                <p class="text-gray-400 text-sm text-center italic">No has definido horarios recurrentes.</p>
                {% endfor %}
            </div>
        </div>

        <!-- SECCI√ìN 2: D√çAS BLOQUEADOS (Con validaci√≥n JS) -->
        <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
            <h2 class="text-lg font-bold text-dark-gray mb-4 flex items-center gap-2">
                üö´ Bloquear Fechas
                <span class="text-xs font-normal text-gray-500 bg-gray-100 px-2 py-1 rounded">Vacaciones / Feriados</span>
            </h2>

            <form method="POST" class="mb-6 bg-red-50 p-4 rounded-md border border-red-100">
                {% csrf_token %}
                <div class="space-y-3">
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="text-xs font-bold text-gray-500 uppercase">Desde Fecha</label>
                            <!-- A√±adimos ID para JS -->
                            <input type="date" name="off-start_date" id="start_date" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary text-sm">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-500 uppercase">Hasta Fecha</label>
                            <!-- A√±adimos ID para JS -->
                            <input type="date" name="off-end_date" id="end_date" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary text-sm">
                        </div>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase">Motivo</label>
                        {{ timeoff_form.description }}
                    </div>
                    <button type="submit" name="submit_off" class="w-full bg-red-500 text-white py-2 rounded hover:bg-red-700 text-sm font-bold">
                        + Bloquear Rango
                    </button>
                </div>
            </form>

            <div class="space-y-2 max-h-60 overflow-y-auto">
                {% for off in time_off_list %}
                <div class="flex justify-between items-center text-sm border-b border-gray-100 pb-2 last:border-0">
                    <div>
                        <div class="font-bold text-gray-700">
                            {{ off.start_date|date:"d M Y" }} 
                            {% if off.start_date != off.end_date %} - {{ off.end_date|date:"d M Y" }} {% endif %}
                        </div>
                        {% if off.description %}
                        <div class="text-xs text-gray-500">{{ off.description }}</div>
                        {% endif %}
                    </div>
                    <form method="POST" action="{% url 'delete_timeoff' off.id %}" onsubmit="return confirm('¬øDesbloquear estos d√≠as?');">
                        {% csrf_token %}
                        <button type="submit" class="text-red-400 hover:text-red-600 font-bold px-2">‚úï</button>
                    </form>
                </div>
                {% empty %}
                <p class="text-gray-400 text-sm text-center italic">No tienes d√≠as bloqueados.</p>
                {% endfor %}
            </div>
        </div>

    </div>
</div>

<script>
    // Script para mejorar la usabilidad de las fechas
    document.addEventListener('DOMContentLoaded', function() {
        const startDateInput = document.getElementById('start_date');
        const endDateInput = document.getElementById('end_date');
        
        // 1. Establecer el m√≠nimo a "HOY" para evitar bloquear el pasado accidentalmente
        const today = new Date().toISOString().split('T')[0];
        startDateInput.setAttribute('min', today);
        endDateInput.setAttribute('min', today);

        // 2. Cuando cambie la fecha de inicio, actualizar el m√≠nimo de la fecha fin
        startDateInput.addEventListener('change', function() {
            endDateInput.setAttribute('min', this.value);
            // Si la fecha fin es menor a la nueva fecha inicio, la actualizamos
            if (endDateInput.value && endDateInput.value < this.value) {
                endDateInput.value = this.value;
            }
        });
    });
</script>
{% endblock %}